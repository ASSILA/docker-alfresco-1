global:
  project: alf
  volumepath: /var/lib/grua/volumes
base:
  build: base
  tag: marsbard/base
  run: false
  before: 
    - tomcat
tomcat:
  build: tomcat
  tag: marsbard/tomcat
  run: false
########################################################################################
consul:
  build: consul
  upwhen: 
    logmsg: "consul: New leader elected: consul"
  options:
    - "--expose=8300"
    - "--expose=8500"
    - "--expose=8600"
  ports:
    - 8300:8300
    - 8500:8500
    - 8600:8600
  volumes:
    - consul/config:/config
    - consul/data:/data
  command: "-data-dir=/data -bootstrap-expect 1 -client 0.0.0.0"
registrator:
  image: gliderlabs/registrator:latest
  link:
    - consul
  volumes:
    - /var/run/docker.sock:/tmp/docker.sock
  before: 
    - postfix
    - alfresco
    - solr
    - share
    - mysql
  after:
    - consul
  command: "-internal consul://consul:8500"
alfresco:
  build: alfresco
  dns: <% GRUA BRIDGE_IP %>
  options:
    - "--expose=2021"
    - "--expose=7070"
    - "--expose=8080"
      #- "--privileged" # TEMP ONLY for debugging with strace
  ports:
    - "8081:8080"
  volumes: 
    - alfresco/repo/data:/data
    - alfresco/repo/logs:/logs
  hostname: alfresco
share:
  build: share
  dns: <% GRUA BRIDGE_IP %>
  options:
    - "--expose=8080"
  ports:
    - "8080:8080"
  volumes: 
    - alfresco/share:/data
  hostname: share
  after:
    - alfresco
  before:
    - solr
solr:
  build: solr
  hostname: solr
  options:
    - "--expose=8080"
  #dns: <% INSPECT dnsdock {{ .NetworkSettings.IPAddress }} %>
  dns: <% GRUA BRIDGE_IP %>
  volumes:
    - alfresco/solr/data:/data
    - alfresco/solr/content:/content
    - alfresco/solr/logs:/logs
mysql:
  hostname: mysql
  dns: <% GRUA BRIDGE_IP %>
  image: mysql:5.6
  options:
    - "--expose=3306"
  volumes: 
    - alfresco/mysql:/var/lib/mysql
  environment:
    MYSQL_DATABASE: alfresco
    MYSQL_USER: alfresco
    MYSQL_PASSWORD: alfresco
    MYSQL_ROOT_PASSWORD: alfresco
  after:
    - consul
  before:
    - alfresco
  upwhen:
    logmsg: "mysqld: ready for connections"
    sleep: 2
postfix:
  hostname: postfix
  dns: <% GRUA BRIDGE_IP %>
  image: "catatnight/postfix"
  options:
    - "--expose=25"
  environment: 
    maildomain: "alfresco.local"
    smtp_user: "mailuser:password"
haveged:
  image: harbur/haveged:1.7c-1
  options:
    - "--privileged"
  before: 
    - alfresco
    - share
    - solr
dockerui:
  image: dockerui/dockerui
  ports:
    - "9000:9000"
  volumes:
    - "/var/run/docker.sock:/var/run/docker.sock"
